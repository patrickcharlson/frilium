{% extends 'frilium/_base.html' %}

{% load crispy_forms_filters static %}

{% block title %}{{ topic.title }} | {{ topic.board.category.name }} | {{ block.super }}{% endblock %}

{% block content %}
    {% block post-header %}
        <div class="go-back">
            <div class="row">
                <div class="btn-back col-lg-1">
                    <a href="{% url 'frilium:thread:board_topics' topic.board.slug %}"
                       class="btn btn-default-back btn-block btn-outline btn-icon">
                        <span class="material-icon">keyboard_arrow_left</span>
                    </a>
                </div>
                <div class="col-md-10">
                    <div class="topic-header">
                        <header>
                            <h1 class="forum-title">{{ topic.title }}</h1>
                        </header>
                    </div>
                </div>
            </div>
        </div>
    {% endblock %}


    <div class="row">
        <div class="col-md-6">
            <div class="float-left">
                <div class="mb-3">
                    {% with post=topic.last_post %}
                        <a href="#p-{{ post.id }}"
                           class="btn last-post btn-sm text-white"
                           role="button">Last post</a>
                    {% endwith %}

                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="float-right">
                <div class="mb-3">
                    <a href="{% url 'frilium:thread:reply_topic' topic.slug %}"
                       class="btn btn-reply  btn-sm text-white"
                       role="button">Reply <i class="fa-fw fas fa-reply"></i></a>
                </div>
            </div>
        </div>
    </div>

    {% for message in messages %}
        <div class="alert {{ message.tags }} alert-dismissible fade show" role="alert">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            <strong><i class="fas fa-info-circle fa-fw"></i> {{ message }}</strong>
        </div>
    {% endfor %}

    {% block participants %}
    {% endblock %}
    {% for post in posts %}
        <div class="card card-posts mb-3 {% if post.user.is_admin %}purple-border{% endif %} ">
            <div class="card-body p-3" id="p-{{ post.id }}">
                <div class="row">
                    <div class="col-9 post-box">
                        <div class="row mb-4 controls">
                            <div class="col-md-6">
                                <div class="float-left">
                                    <strong class="text-muted">
                                        posted
                                        <a class="posted-on"
                                           href="{{ post.url }}#p-{{ post.id }}">{{ post.created_at|humanizetime }}</a>
                                    </strong>
                                </div>

                            </div>
                            <div class="col-md-6">
                                <div class="float-right">
                                    {% if post.user == user %}
                                        {% if forloop.first %}
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-secondary control-menu" type="button"
                                                        id="dropdownMenuButton" data-toggle="dropdown"
                                                        aria-haspopup="true"
                                                        aria-expanded="false">
                                                    <i class="material-icon">more_horiz</i>
                                                </button>
                                                <div class="dropdown-menu ffcMenu ffcMenu_bottomRight arrow_box"
                                                     aria-labelledby="dropdownMenuButton">
                                                    <a class="dropdown-menu-item"
                                                       href="{% url 'frilium:post:report:report' post.pk %}">Report</a>
                                                    <a class="dropdown-menu-item" href="#">Share</a>
                                                    <a class="dropdown-sep" href="">
                                                        <hr>
                                                    </a>
                                                    <a class="dropdown-menu-item"
                                                       href="{% url 'frilium:thread:edit_topic' post.topic.slug %}">
                                                        Edit</a>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-secondary control-menu" type="button"
                                                        id="dropdownMenuButton" data-toggle="dropdown"
                                                        aria-haspopup="true"
                                                        aria-expanded="false">
                                                    <i class="material-icon">more_horiz</i>
                                                </button>
                                                <div class="dropdown-menu ffcMenu ffcMenu_bottomRight arrow_box"
                                                     aria-labelledby="dropdownMenuButton">
                                                    <a class="dropdown-menu-item"
                                                       href="{% url 'frilium:post:report:report' post.pk %}">Report</a>
                                                    <a class="dropdown-menu-item" href="#">Share</a>
                                                    <a class="dropdown-sep" href="">
                                                        <hr>
                                                    </a>
                                                    <a class="dropdown-menu-item"
                                                       href="{% url 'frilium:post:edit_post' post.slug %}">Edit</a>

                                                    <a onclick="return confirm('Are you sure you want to delete this post?')"
                                                       class="dropdown-menu-item"
                                                       href="{% url 'frilium:post:delete_post' post.slug %}">Delete</a>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-secondary control-menu" type="button"
                                                    id="dropdownMenuButton" data-toggle="dropdown"
                                                    aria-haspopup="true"
                                                    aria-expanded="false">
                                                <i class="material-icon">more_horiz</i>
                                            </button>
                                            <div class="dropdown-menu ffcMenu ffcMenu_bottomRight arrow_box"
                                                 aria-labelledby="dropdownMenuButton">
                                                <a class="dropdown-menu-item"
                                                   href="{% url 'frilium:post:report:report' post.pk %}">Report</a>
                                                <a class="dropdown-menu-item" href="#">Share</a>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="post-message">
                            <p>{{ post.get_message_as_markdown }}</p>
                        </div>
                        <div class="post-footer">
                            {% if post.updated_at %}
                                <p class="post-edit"><em>Edited by {{ post.updated_by }}
                                    <abbr title="{{ post.updated_at }}">{{ post.updated_at|humanizetime }}</abbr></em>
                                </p>
                            {% endif %}
                            {% if topic.last_updated and topic.first_post == post.post_id %}
                                <p class="post-edit"><em>Edited by {{ topic.updated_by }}
                                    <abbr title="{{ topic.last_updated }}">{{ topic.last_updated|humanizetime }}</abbr></em>
                                </p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-3 author-box">
                        <h3 class="profile-user-name text-center">
                            <strong><a href="{{ post.user.get_absolute_url }}" class="user-name">{{ post.user }}</a></strong>
                        </h3>
                        <div class="avatar-wrap d-flex justify-content-center">
                            <a href="{{ post.user.get_absolute_url }}">
                                <img width="90" height="90" src="{% avatar_url post.user '150' %}"
                                     alt="{{ post.user }}"
                                     class="circular"> </a>
                            <span data-toggle="tooltip"
                                  data-placement="top"
                                  title="online now"
                                  class="avatar-online"></span>

                            {% if post.user.is_admin %}
                                <span data-toggle="tooltip"
                                      data-placement="top"
                                      title="{{ post.user }} is a moderator"
                                      class="author_badge">
                                    <span class="material-icon">security</span>
                                </span>
                            {% endif %}

                        </div>
                        <h4 class="profile-meta">
                            <small class="profile-user-title">Team member</small>
                        </h4>
                        <ul class="profile-stats">
                            <li class="profile-stat">
                                <h5 class="profile-stat-wrap">
                                    <span class="profile-stat-title">
                                        <small class="profile-stat-value">
                                            {{ post.user.post_count }}</small>
                                        post{{ post.user.post_count|pluralize }}</span>
                                </h5>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}

    <div class="row">
        <div class="col-md-6">
            <div class="float-left">
                <div class="mb-4 my-2">
                    {% include 'frilium/includes/pagination.html' %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="float-right">
                <div class="mb-4">
                    <a href="{% url 'frilium:thread:reply_topic' topic.slug %}"
                       class="btn btn-reply btn-sm text-white"
                       role="button">Reply <i class="fa-fw fas fa-reply"></i></a>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block javascript %}
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>

{% endblock %}